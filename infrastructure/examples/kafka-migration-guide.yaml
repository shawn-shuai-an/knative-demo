# Knative Demo è¿ç§»åˆ° Kafka å®Œæ•´æŒ‡å—

# ==========================================
# å½“å‰æ¶æ„ (InMemoryChannel)
# ==========================================

current-architecture: |
  Producer â†’ Broker (InMemory) â†’ InMemoryChannel â†’ Trigger (ç±»å‹è¿‡æ»¤) â†’ Consumer
  
  æ‰€æœ‰äº‹ä»¶ç±»å‹ (demo.event, user.created, order.placed) 
  â†’ åŒä¸€ä¸ª InMemoryChannel 
  â†’ æ ¹æ® event.type è¿‡æ»¤åˆ†å‘

# ==========================================
# è¿ç§»åˆ° Kafka çš„ Topic ç­–ç•¥å¯¹æ¯”
# ==========================================

---
# ç­–ç•¥1: å• Topic ç­–ç•¥ (æ¨èï¼Œä¸ç°æœ‰æ¶æ„ä¸€è‡´)
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-single-topic-config
  namespace: knative-eventing
data:
  # æ‰€æœ‰äº‹ä»¶ç±»å‹å…±ç”¨ä¸€ä¸ª Topic
  default-topic-config: |
    # Topic åç§°ï¼šknative-broker-default
    # åˆ†åŒºæ•°ï¼š10 (æ”¯æŒå¹¶è¡Œå¤„ç†)
    # å‰¯æœ¬æ•°ï¼š3 (é«˜å¯ç”¨)
    
    # äº‹ä»¶è·¯ç”±æ–¹å¼ï¼š
    # 1. æ‰€æœ‰äº‹ä»¶ç±»å‹å†™å…¥åŒä¸€ä¸ª Topic
    # 2. Trigger åŸºäº CloudEvent å±æ€§ (type) è¿‡æ»¤
    # 3. æ— éœ€ä¸ºæ¯ä¸ª Trigger é…ç½®å•ç‹¬ Topic

single-topic-architecture: |
  Producer â†’ Kafka Broker â†’ Single Topic (knative-broker-default)
                              â†“
                         æ‰€æœ‰äº‹ä»¶ç±»å‹æ··åˆå­˜å‚¨
                              â†“
                    Trigger åŸºäº event.type è¿‡æ»¤:
                    â”œâ”€â”€ demo.event â†’ Consumer
                    â”œâ”€â”€ user.created â†’ Consumer  
                    â””â”€â”€ order.placed â†’ Consumer

---
# ç­–ç•¥2: å¤š Topic ç­–ç•¥ (å¯é€‰ï¼Œæ›´ç»†ç²’åº¦æ§åˆ¶)
multi-topic-config: |
  # ä¸ºæ¯ä¸ªäº‹ä»¶ç±»å‹åˆ›å»ºå•ç‹¬ Topic
  # Topic å‘½åï¼šknative-broker-{event-type}
  #   - knative-broker-demo-event
  #   - knative-broker-user-created
  #   - knative-broker-order-placed

multi-topic-architecture: |
  Producer â†’ Kafka Broker â†’ Multiple Topics:
                            â”œâ”€â”€ demo.event â†’ Topic-1 â†’ Trigger-1 â†’ Consumer
                            â”œâ”€â”€ user.created â†’ Topic-2 â†’ Trigger-2 â†’ Consumer
                            â””â”€â”€ order.placed â†’ Topic-3 â†’ Trigger-3 â†’ Consumer

# ==========================================
# è¿ç§»æ–¹æ¡ˆ1: MTChannelBasedBroker + KafkaChannel
# ==========================================

---
# 1.1 å®‰è£… Kafka (é€‰æ‹© Bitnami Helm - æœ€ç®€å•)
kafka-installation: |
  # å®‰è£…å‘½ä»¤:
  helm repo add bitnami https://charts.bitnami.com/bitnami
  helm install kafka bitnami/kafka \
    --set replicaCount=3 \
    --set persistence.enabled=true \
    --set persistence.size=10Gi \
    --set zookeeper.persistence.enabled=true \
    --set zookeeper.persistence.size=5Gi

---
# 1.2 é…ç½® KafkaChannel ä¸ºé»˜è®¤ Channel
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-br-default-channel
  namespace: knative-eventing
data:
  channel-template-spec: |
    apiVersion: messaging.knative.dev/v1beta1
    kind: KafkaChannel
    spec:
      numPartitions: 10
      replicationFactor: 3
      retentionDuration: P7D  # 7å¤©ä¿ç•™æœŸ

---
# 1.3 åˆ›å»º Kafka è¿æ¥é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-kafka
  namespace: knative-eventing
data:
  bootstrapServers: "kafka.default.svc.cluster.local:9092"

---
# 1.4 ä½ çš„ Trigger ä¿æŒä¸å˜ï¼
existing-triggers-unchanged: |
  # âœ… demo-event-trigger     - filter: type=demo.event
  # âœ… user-created-trigger   - filter: type=user.created  
  # âœ… order-placed-trigger   - filter: type=order.placed
  #
  # æ— éœ€ä¿®æ”¹ï¼Kafka è¿ç§»å¯¹ Trigger é€æ˜

# ==========================================
# è¿ç§»æ–¹æ¡ˆ2: Native Kafka Broker (æ¨èç”Ÿäº§)
# ==========================================

---
# 2.1 å®‰è£… Knative Kafka Broker
kafka-broker-installation: |
  # å®‰è£… Knative Kafka æ‰©å±•:
  kubectl apply -f https://github.com/knative-extensions/eventing-kafka-broker/releases/latest/download/eventing-kafka-controller.yaml
  kubectl apply -f https://github.com/knative-extensions/eventing-kafka-broker/releases/latest/download/eventing-kafka-broker.yaml

---
# 2.2 åˆ›å»º Native Kafka Broker é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-broker-config
  namespace: knative-eventing
data:
  bootstrap.servers: "kafka.default.svc.cluster.local:9092"
  # å• Topic ç­–ç•¥é…ç½®
  default.topic.partitions: "10"
  default.topic.replication.factor: "3"
  default.topic.retention.ms: "604800000"  # 7å¤©

---
# 2.3 åˆ›å»ºæˆ–ä¿®æ”¹ç°æœ‰ Broker
apiVersion: eventing.knative.dev/v1
kind: Broker
metadata:
  name: kafka-broker  # æ–°å»ºï¼Œæˆ–æ›¿æ¢ç°æœ‰çš„ default
  namespace: knative-demo
  annotations:
    eventing.knative.dev/broker.class: Kafka  # å…³é”®ï¼šä½¿ç”¨ Kafka Broker
spec:
  config:
    apiVersion: v1
    kind: ConfigMap
    name: kafka-broker-config
    namespace: knative-eventing

---
# 2.4 æ›´æ–° Trigger æŒ‡å‘æ–° Broker (å¦‚æœæ–°å»ºäº† kafka-broker)
trigger-update-example: |
  # é€‰é¡¹A: ä¿®æ”¹ç°æœ‰ Broker ä¸º Kafka ç±»å‹
  kubectl patch broker default -n knative-demo \
    --type='merge' \
    -p='{"metadata":{"annotations":{"eventing.knative.dev/broker.class":"Kafka"}}}'
  
  # é€‰é¡¹B: æ›´æ–° Trigger æŒ‡å‘æ–° Broker
  kubectl patch trigger demo-event-trigger -n knative-demo \
    --type='merge' \
    -p='{"spec":{"broker":"kafka-broker"}}'

# ==========================================
# è¿ç§»æ­¥éª¤æ€»ç»“
# ==========================================

migration-steps: |
  
  ğŸ“‹ å®Œæ•´è¿ç§»æ¸…å•:
  
  â–¡ æ­¥éª¤1: å®‰è£… Kafka é›†ç¾¤
     â”œâ”€â”€ helm install kafka bitnami/kafka
     â””â”€â”€ éªŒè¯: kubectl get pods -l app.kubernetes.io/name=kafka
  
  â–¡ æ­¥éª¤2: å®‰è£… Knative Kafka ç»„ä»¶  
     â”œâ”€â”€ kubectl apply -f eventing-kafka-controller.yaml
     â””â”€â”€ kubectl apply -f eventing-kafka-broker.yaml
  
  â–¡ æ­¥éª¤3: é€‰æ‹©è¿ç§»ç­–ç•¥
     â”œâ”€â”€ æ–¹æ¡ˆA: ä¿®æ”¹ç°æœ‰ Broker ç±»å‹ (é›¶åœæœº)
     â””â”€â”€ æ–¹æ¡ˆB: åˆ›å»ºæ–° Kafka Broker (å¹¶è¡Œæµ‹è¯•)
  
  â–¡ æ­¥éª¤4: éªŒè¯äº‹ä»¶æµ
     â”œâ”€â”€ æ£€æŸ¥ Producer ä»åœ¨å‘é€äº‹ä»¶
     â”œâ”€â”€ æ£€æŸ¥ Consumer ä»åœ¨æ¥æ”¶äº‹ä»¶  
     â””â”€â”€ æ£€æŸ¥ Kafka Topic å·²åˆ›å»ºå¹¶æœ‰æ•°æ®
  
  â–¡ æ­¥éª¤5: æ¸…ç†æ—§èµ„æº (å¯é€‰)
     â””â”€â”€ åˆ é™¤æ—§çš„ InMemoryChannel

# ==========================================
# Topic è‡ªåŠ¨åˆ›å»ºéªŒè¯
# ==========================================

verify-topics: |
  # æ£€æŸ¥è‡ªåŠ¨åˆ›å»ºçš„ Topic:
  kubectl exec -it kafka-0 -- kafka-topics.sh \
    --bootstrap-server localhost:9092 \
    --list
  
  # é¢„æœŸçœ‹åˆ°:
  # knative-broker-knative-demo-default (å• Topic ç­–ç•¥)
  # æˆ–
  # knative-broker-knative-demo-default-demo-event
  # knative-broker-knative-demo-default-user-created  
  # knative-broker-knative-demo-default-order-placed (å¤š Topic ç­–ç•¥)

---
# å…³é”®æ”¶ç›Šå¯¹æ¯”
benefits-comparison: |
  
  | ç‰¹æ€§                | InMemoryChannel | KafkaChannel      |
  |--------------------|-----------------|-------------------|
  | **æŒä¹…åŒ–**          | âŒ é‡å¯ä¸¢å¤±      | âœ… æŒä¹…åŒ–å­˜å‚¨      |
  | **äº‹ä»¶å›æ”¾**        | âŒ ä¸æ”¯æŒ        | âœ… æ”¯æŒ 7 å¤©å›æ”¾   |
  | **é«˜å¯ç”¨**          | âŒ å•ç‚¹æ•…éšœ      | âœ… 3 å‰¯æœ¬é›†ç¾¤      |
  | **æ‰©å®¹èƒ½åŠ›**        | ğŸŸ¡ å†…å­˜é™åˆ¶      | ğŸš€ æ°´å¹³æ‰©å±•       |
  | **ç›‘æ§èƒ½åŠ›**        | ğŸŸ¡ åŸºç¡€ç›‘æ§      | ğŸš€ ä¸°å¯Œç›‘æ§       |
  | **Trigger é…ç½®**   | âœ… æ— éœ€æ”¹åŠ¨      | âœ… æ— éœ€æ”¹åŠ¨       | 