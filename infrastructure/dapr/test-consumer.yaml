apiVersion: apps/v1
kind: Deployment
metadata:
  name: dapr-test-consumer
  namespace: dapr-demo
spec:
  replicas: 2  # éƒ¨ç½²2ä¸ªå®ä¾‹æµ‹è¯•è´Ÿè½½å‡è¡¡
  selector:
    matchLabels:
      app: test-consumer
  template:
    metadata:
      labels:
        app: test-consumer
      annotations:
        dapr.io/enabled: "true"
        dapr.io/app-id: "test-consumer"
        dapr.io/app-port: "8080"
    spec:
      containers:
      - name: consumer
        image: nginx:alpine
        ports:
        - containerPort: 8080
        command: ["/bin/sh"]
        args:
        - -c
        - |
          # åˆ›å»ºæ¶ˆè´¹è€…è„šæœ¬
          cat > /tmp/test-consumer.sh << 'EOF'
          #!/bin/sh
          
          # è·å–Podåç§°ç”¨äºæ ‡è¯†
          HOSTNAME=$(hostname)
          
          echo "Starting Dapr test consumer on $HOSTNAME..."
          
          # å¯åŠ¨HTTPæœåŠ¡å™¨å¤„ç†Daprçš„è®¢é˜…è¯·æ±‚
          while true; do
            # ä½¿ç”¨netcatç›‘å¬ç«¯å£8080
            {
              read -r request_line
              read -r host_header
              
              # è¯»å–Content-Length
              content_length=0
              while IFS= read -r header && [ "$header" != $'\r' ]; do
                if echo "$header" | grep -qi "Content-Length:"; then
                  content_length=$(echo "$header" | cut -d' ' -f2 | tr -d '\r')
                fi
              done
              
              # è¯»å–è¯·æ±‚ä½“
              if [ "$content_length" -gt 0 ]; then
                body=$(head -c "$content_length")
              else
                body=""
              fi
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯è®¢é˜…è¯·æ±‚
              if echo "$request_line" | grep -q "GET /dapr/subscribe"; then
                # è¿”å›è®¢é˜…é…ç½®
                echo "HTTP/1.1 200 OK"
                echo "Content-Type: application/json"
                echo "Content-Length: 131"
                echo ""
                echo '[{"pubsubname":"pubsub","topic":"pod-events","route":"/pod-events","metadata":{"rawPayload":"false"}}]'
              elif echo "$request_line" | grep -q "POST /pod-events"; then
                # å¤„ç†æ¶ˆæ¯
                echo "ğŸ”¥ [$HOSTNAME] Received message: $body"
                
                # è§£æJSON (ç®€å•æ–¹å¼)
                message=$(echo "$body" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
                timestamp=$(echo "$body" | grep -o '"timestamp":"[^"]*"' | cut -d'"' -f4)
                
                echo "ğŸ“‹ [$HOSTNAME] Message: $message"
                echo "â° [$HOSTNAME] Timestamp: $timestamp"
                
                # è¿”å›æˆåŠŸå“åº”
                echo "HTTP/1.1 200 OK"
                echo "Content-Type: application/json"
                echo "Content-Length: 27"
                echo ""
                echo '{"status":"success"}'
              elif echo "$request_line" | grep -q "GET /health"; then
                # å¥åº·æ£€æŸ¥
                echo "HTTP/1.1 200 OK"
                echo "Content-Type: application/json"
                echo "Content-Length: 22"
                echo ""
                echo '{"status":"healthy"}'
              else
                # é»˜è®¤å“åº”
                echo "HTTP/1.1 200 OK"
                echo "Content-Type: text/plain"
                echo "Content-Length: 12"
                echo ""
                echo "Hello World!"
              fi
            } | nc -l -p 8080
          done
          EOF
          
          chmod +x /tmp/test-consumer.sh
          /tmp/test-consumer.sh
---
apiVersion: v1
kind: Service
metadata:
  name: test-consumer-service
  namespace: default
spec:
  selector:
    app: test-consumer
  ports:
  - port: 8080
    targetPort: 8080 