# Dapr ÂÆåÊï¥‰∫ã‰ª∂È©±Âä®Êû∂ÊûÑÊºîÁ§∫
# Êû∂ÊûÑÔºöProducer (SDK) ‚Üí Dapr Sidecar ‚Üí Pub/Sub Component ‚Üí Dapr Sidecar ‚Üí Consumer

---
# 1. ÂëΩÂêçÁ©∫Èó¥
apiVersion: v1
kind: Namespace
metadata:
  name: dapr-demo

---
# 2. Pub/Sub Component - Ê∂àÊÅØÈòüÂàóÁªÑ‰ª∂
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: pubsub
  namespace: dapr-demo
spec:
  type: pubsub.redis
  version: v1
  metadata:
  - name: redisHost
    value: "redis-master.default.svc.cluster.local:6379"
  - name: redisPassword
    value: ""
  - name: redisDB
    value: "0"

---
# 3. Producer ConfigMap - ‰ΩøÁî® Dapr SDK
apiVersion: v1
kind: ConfigMap
metadata:
  name: producer-code
  namespace: dapr-demo
data:
  main.py: |
    #!/usr/bin/env python3
    """
    Dapr Producer ‰ΩøÁî® SDK ÁâàÊú¨
    Ëá™Âä®Â§ÑÁêÜ‰∏é sidecar ÁöÑÈÄö‰ø°ÔºåÊó†ÈúÄÊåáÂÆö localhost
    """
    
    import time
    import json
    import uuid
    import asyncio
    from datetime import datetime
    from dapr.clients import DaprClient
    
    # Pub/Sub ÈÖçÁΩÆ
    PUBSUB_NAME = "pubsub"
    TOPICS = ["user.created", "order.placed", "payment.processed"]
    
    def create_event_data(topic):
        """ÂàõÂª∫‰∫ã‰ª∂Êï∞ÊçÆ"""
        return {
            "id": str(uuid.uuid4()),
            "source": "dapr-producer-sdk",
            "type": topic,
            "time": datetime.utcnow().isoformat() + "Z",
            "data": {
                "message": f"Hello from {topic}",
                "timestamp": time.time(),
                "producer": "dapr-sdk-version"
            }
        }
    
    def main():
        print("üöÄ Starting Dapr Producer with SDK...")
        print(f"üìã Publishing to topics: {TOPICS}")
        
        # ‰ΩøÁî® Dapr Client SDK - Ëá™Âä®ÂèëÁé∞ sidecar
        with DaprClient() as dapr_client:
            counter = 0
            
            while True:
                try:
                    # ËΩÆÊµÅÂèëÈÄÅ‰∏çÂêåÁ±ªÂûãÁöÑ‰∫ã‰ª∂
                    topic = TOPICS[counter % len(TOPICS)]
                    event_data = create_event_data(topic)
                    
                    # ‰ΩøÁî® SDK ÂèëÂ∏É‰∫ã‰ª∂ - Êó†ÈúÄÊåáÂÆö localhost:3500
                    dapr_client.publish_event(
                        pubsub_name=PUBSUB_NAME,
                        topic_name=topic,
                        data=json.dumps(event_data),
                        data_content_type="application/json"
                    )
                    
                    counter += 1
                    print(f"‚úÖ [SDK] Published {topic} (#{counter}): {event_data['id']}")
                    
                except Exception as e:
                    print(f"‚ùå [SDK] Error publishing event: {e}")
                
                time.sleep(5)
    
    if __name__ == "__main__":
        main()

  requirements.txt: |
    dapr
    dapr-ext-grpc

---
# 4. ‰∫ã‰ª∂Áîü‰∫ßËÄÖ Deployment - ‰ΩøÁî® SDK
apiVersion: apps/v1
kind: Deployment
metadata:
  name: event-producer
  namespace: dapr-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: producer
  template:
    metadata:
      labels:
        app: producer
      annotations:
        dapr.io/enabled: "true"
        dapr.io/app-id: "event-producer"
        dapr.io/app-port: "6000"
    spec:
      containers:
      - name: producer
        image: python:3.11-slim
        ports:
        - containerPort: 6000
        volumeMounts:
        - name: producer-code
          mountPath: /app
        workingDir: /app
        command: ["/bin/bash"]
        args:
        - -c
        - |
          echo "üì¶ Installing Dapr SDK..."
          pip install -r requirements.txt > /dev/null 2>&1
          echo "üöÄ Starting Producer with Dapr SDK..."
          python main.py
      volumes:
      - name: producer-code
        configMap:
          name: producer-code
          defaultMode: 0755

---
# 5. Consumer ConfigMap - ÂÆåÊï¥ÁöÑÊ∂àË¥πËÄÖ‰ª£Á†Å
apiVersion: v1
kind: ConfigMap
metadata:
  name: consumer-code
  namespace: dapr-demo
data:
  main.py: |
    #!/usr/bin/env python3
    """
    Dapr Consumer ÂÆåÊï¥ÂÆûÁé∞
    Â§ÑÁêÜÊù•Ëá™‰∏çÂêå Topic ÁöÑ‰∫ã‰ª∂
    """
    
    import json
    import time
    import threading
    from datetime import datetime
    from flask import Flask, request, jsonify
    
    app = Flask(__name__)
    
    # ÁªüËÆ°‰ø°ÊÅØ
    stats = {
        'total_processed': 0,
        'by_topic': {},
        'start_time': time.time(),
        'last_event_time': None
    }
    stats_lock = threading.Lock()
    
    def update_stats(topic):
        """Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ"""
        with stats_lock:
            stats['total_processed'] += 1
            stats['by_topic'][topic] = stats['by_topic'].get(topic, 0) + 1
            stats['last_event_time'] = datetime.utcnow().isoformat()
    
    def log_event(topic, event_data, request_headers):
        """ËÆ∞ÂΩï‰∫ã‰ª∂‰ø°ÊÅØ"""
        event_id = event_data.get('id', 'unknown')
        event_source = event_data.get('source', 'unknown')
        
        print(f"üéØ [{stats['total_processed']}] Received {topic}")
        print(f"   Event ID: {event_id}")
        print(f"   Source: {event_source}")
        print(f"   Data: {event_data.get('data', {})}")
        print(f"   Headers: {dict(request.headers)}")
        print(f"   Timestamp: {datetime.utcnow().isoformat()}")
        print("   " + "="*50)
    
    @app.route('/dapr/subscribe', methods=['GET'])
    def subscribe():
        """
        Dapr ËÆ¢ÈòÖÈÖçÁΩÆÁ´ØÁÇπ
        ÂÆö‰πâÂ∫îÁî®Ë¶ÅËÆ¢ÈòÖÁöÑ Topic ÂíåÂØπÂ∫îÁöÑË∑ØÁî±
        """
        subscriptions = [
            {
                "pubsubname": "pubsub",
                "topic": "user.created",
                "route": "/user-events",
                "metadata": {
                    "consumerGroup": "user-processors"
                }
            },
            {
                "pubsubname": "pubsub", 
                "topic": "order.placed",
                "route": "/order-events",
                "metadata": {
                    "consumerGroup": "order-processors"
                }
            },
            {
                "pubsubname": "pubsub",
                "topic": "payment.processed", 
                "route": "/payment-events",
                "metadata": {
                    "consumerGroup": "payment-processors"
                }
            }
        ]
        
        print(f"üìã Dapr requesting subscriptions, returning {len(subscriptions)} topics")
        return jsonify(subscriptions)
    
    @app.route('/user-events', methods=['POST'])
    def handle_user_events():
        """Â§ÑÁêÜÁî®Êà∑Áõ∏ÂÖ≥‰∫ã‰ª∂"""
        return process_event('user.created')
    
    @app.route('/order-events', methods=['POST'])
    def handle_order_events():
        """Â§ÑÁêÜËÆ¢ÂçïÁõ∏ÂÖ≥‰∫ã‰ª∂"""
        return process_event('order.placed')
    
    @app.route('/payment-events', methods=['POST'])
    def handle_payment_events():
        """Â§ÑÁêÜÊîØ‰ªòÁõ∏ÂÖ≥‰∫ã‰ª∂"""
        return process_event('payment.processed')
    
    def process_event(event_type):
        """ÈÄöÁî®‰∫ã‰ª∂Â§ÑÁêÜÈÄªËæë"""
        try:
            # Ëé∑Âèñ‰∫ã‰ª∂Êï∞ÊçÆ
            event_data = request.get_json() or {}
            
            # Êõ¥Êñ∞ÁªüËÆ°
            update_stats(event_type)
            
            # ËÆ∞ÂΩï‰∫ã‰ª∂
            log_event(event_type, event_data, request.headers)
            
            # Ê®°Êãü‰∏öÂä°Â§ÑÁêÜÊó∂Èó¥
            processing_time = 0.1
            if event_type == 'order.placed':
                processing_time = 0.2  # ËÆ¢ÂçïÂ§ÑÁêÜÊõ¥Â§çÊùÇ
            elif event_type == 'payment.processed':
                processing_time = 0.15  # ÊîØ‰ªòÂ§ÑÁêÜ‰∏≠Á≠âÂ§çÊùÇ
            
            time.sleep(processing_time)
            
            # ËøîÂõûÊàêÂäüÂìçÂ∫îÔºàDapr ÊúüÊúõÁöÑÊ†ºÂºèÔºâ
            return jsonify({
                "status": "SUCCESS",
                "message": f"Processed {event_type}",
                "event_id": event_data.get('id', 'unknown'),
                "processed_at": datetime.utcnow().isoformat()
            }), 200
            
        except Exception as e:
            print(f"‚ùå Error processing {event_type}: {str(e)}")
            # ËøîÂõûÈîôËØØÔºåDapr ‰ºöÈáçËØï
            return jsonify({
                "status": "RETRY", 
                "error": str(e)
            }), 500
    
    @app.route('/health', methods=['GET'])
    def health_check():
        """ÂÅ•Â∫∑Ê£ÄÊü•Á´ØÁÇπ"""
        uptime = time.time() - stats['start_time']
        
        with stats_lock:
            current_stats = dict(stats)
        
        return jsonify({
            "status": "healthy",
            "service": "dapr-consumer",
            "uptime_seconds": round(uptime, 2),
            "total_processed": current_stats['total_processed'],
            "by_topic": current_stats['by_topic'],
            "last_event_time": current_stats['last_event_time'],
            "events_per_minute": round((current_stats['total_processed'] / max(uptime / 60, 1)), 2)
        })
    
    @app.route('/stats', methods=['GET'])
    def detailed_stats():
        """ËØ¶ÁªÜÁªüËÆ°‰ø°ÊÅØ"""
        uptime = time.time() - stats['start_time']
        
        with stats_lock:
            current_stats = dict(stats)
        
        return jsonify({
            "service_info": {
                "name": "dapr-consumer",
                "version": "1.0.0",
                "framework": "dapr + flask"
            },
            "runtime_stats": {
                "uptime_seconds": round(uptime, 2),
                "total_events_processed": current_stats['total_processed'],
                "events_per_second": round(current_stats['total_processed'] / max(uptime, 1), 2),
                "last_event_time": current_stats['last_event_time']
            },
            "topic_breakdown": current_stats['by_topic'],
            "subscriptions": [
                "user.created ‚Üí /user-events",
                "order.placed ‚Üí /order-events", 
                "payment.processed ‚Üí /payment-events"
            ]
        })
    
    if __name__ == "__main__":
        print("üöÄ Starting Dapr Consumer Service...")
        print("üìã Subscribing to topics: user.created, order.placed, payment.processed")
        print("üåê Serving on port 6001")
        
        app.run(host='0.0.0.0', port=6001, debug=False)

  requirements.txt: |
    flask

---
# 6. ‰∫ã‰ª∂Ê∂àË¥πËÄÖ Deployment - ÂÆåÊï¥ÈÖçÁΩÆ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: event-consumer
  namespace: dapr-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: consumer
  template:
    metadata:
      labels:
        app: consumer
      annotations:
        dapr.io/enabled: "true"
        dapr.io/app-id: "event-consumer"
        dapr.io/app-port: "6001"
    spec:
      containers:
      - name: consumer
        image: python:3.11-slim
        ports:
        - containerPort: 6001
        volumeMounts:
        - name: consumer-code
          mountPath: /app
        workingDir: /app
        command: ["/bin/bash"]
        args:
        - -c
        - |
          echo "üì¶ Installing Flask..."
          pip install -r requirements.txt > /dev/null 2>&1
          echo "üöÄ Starting Consumer..."
          python main.py
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: consumer-code
        configMap:
          name: consumer-code
          defaultMode: 0755

---
# 7. Ê∂àË¥πËÄÖÊúçÂä°
apiVersion: v1
kind: Service
metadata:
  name: event-consumer-service
  namespace: dapr-demo
spec:
  selector:
    app: consumer
  ports:
  - name: http
    port: 80
    targetPort: 6001
    protocol: TCP
  type: ClusterIP

---
# 8. Redis ÈÉ®ÁΩ≤
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        args: 
        - redis-server
        - --appendonly
        - "yes"
        - --appendfsync
        - everysec
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: redis-storage
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: redis-master
  namespace: default
spec:
  selector:
    app: redis
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
    protocol: TCP
  type: ClusterIP 